{% extends 'base/base_user.html' %}
{% load static %}

{% block content %}


<div class="card col-lg-12" style="max-width: auto;">
    <div class="card-header text-center d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="h5 mb-0 ">
            {{ event.name }} || {{ event.team_type }} || {{ event.team_person }}
        </div>
        <div class="">
            <a href="{% url 'user_side:event_user' %}" class="btn btn-primary btn-sm">Back to list</a>
            {% if event.created_by == request.user %}
                <a href="{% url 'user_side:edit_event' event.id %}" class="btn btn-info btn-sm">Edit Event</a>
                
            {% endif %}

            {% if is_del %}
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteEventModal">Delete Event</button>
            {% endif %}

            
            
            {% if is_join %}
                <a href="{% url 'user_side:join_team_event' event.id %}" class="btn btn-success btn-sm">Join Event</a>
            {% else %}
                <a class="btn btn-success btn-sm" deactivate>Join Event</a>
            {% endif %}
                
            {% if event.created_by == request.user and not matches %}
                <a href="#" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#startTournamentModal">Start Tournament</a>
            {% endif %}

            <!-- Modal -->
            <div class="modal fade" id="startTournamentModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel">Start Tournament</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Maximum Teams Allowed:</strong> <span id="maxTeams"></span></p>
                            <p><strong>Teams Registered:</strong> <span id="registeredTeams"></span></p>
                            <p id="warningMessage" class="text-danger"></p>
                            <p>Do you really want to start the tournament?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                            <a href="#" id="confirmStartBtn" class="btn btn-danger">Yes, Start</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Event Modal -->
            <div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel">Delete Event</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete the event "<strong>{{ event.name }}</strong>"?</p>
                            <p class="text-danger">This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <a href="{% url 'user_side:delete_event' event.id %}" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</a>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    // Dummy data (Replace these values dynamically in Django template context)
                    const maxTeams = {{ event.max_number_team }};
                    const registeredTeams = {{ event.registered_team.count }};

                    document.getElementById("maxTeams").innerText = maxTeams;
                    document.getElementById("registeredTeams").innerText = registeredTeams;

                    const warningMessage = document.getElementById("warningMessage");
                    if (registeredTeams < maxTeams) {
                        warningMessage.innerText = "Warning: Not all slots are filled.";
                    } else {
                        warningMessage.innerText = "";
                    }

                    // Handle confirmation click
                    document.getElementById("confirmStartBtn").addEventListener("click", function () {
                        window.location.href = "{% url 'user_side:start_tournament' event.id %}";
                    });
                });
            </script>
        </div>
    </div>
    
    <div class="d-flex align-items-center gap-3 p-4 position-relative">
        <div class="" >
            {% if event.image %}
                <img src="{{event.image.url}}" class="img-fluid rounded-start" alt="Event Image" style="margin:10px auto;">
            {% else %}
                <img src="https://pickleit.app/static/images/pickleit_newlogo.jpg" class="img-fluid rounded-start" alt="Event Image" style="margin:10px auto;">
            {% endif %}
            
        </div>
        <div class="">
            <div class="card-body">
                <p><strong>Max Join Team:</strong> {{ event.max_number_team }} || 
                   <strong>Joined Team:</strong> {{ event.registered_team.count }}</p>
                <p><strong>Event Registration Duration:</strong> 
                   {{ event.registration_start_date }} - {{ event.registration_end_date }}</p>
                <p><strong>Event Start Duration:</strong> 
                   {{ event.leagues_start_date }} - {{ event.leagues_end_date }}</p>
                <p><strong>Event Organizers:</strong> 
                   {{ event.created_by.first_name }} {{ event.created_by.last_name }}</p>
            </div>
        </div>
        {% if score_update %}
            <a href="{% url 'user_side:event_update_score' event.id %}" class="btn btn-primary btn-sm position-absolute update-score-btn">Update Score</a>
        {% endif %}
        
    </div>
</div>

<!-- Joined Teams -->
{% if not r_group %}
    <div class="card text-center">
        <div class="card-header text-center d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <h2 class="h5">Joined Teams</h2>
        </div>
        <div class="card-body">
            <div class="row">
                {% for team in event.registered_team.all %}
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                        <div class="card team-card h-100 border-0 shadow-sm text-center p-2">
                            {% if team.team_image %}
                                <img src="{{ team.team_image.url }}" alt="{{ team.name }}" class="rounded-circle mb-2" width="80" height="80">
                            {% else %}
                                <img src="https://pickleit.app/static/images/pickleit_newlogo.jpg" alt="{{ team.name }}" class="rounded-circle mb-2" width="80" height="80">
                            {% endif %}
                            <h6 class="card-title mb-0">{{ team.name }}</h6>
                        </div>
                    </div>
                {% empty %}
                    <p>No teams have joined yet.</p>
                {% endfor %}
            </div>
        </div>
        
    </div>
{% else %}
    <div class="card text-center mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <h2 class="h5 mb-0">Group Of Teams</h2>
    </div>
    <div class="card-body">

        {% for court in r_group %}
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Court {{ forloop.counter }}</h5>
                </div>
                <div class="card-body">
                    {% if court.all_teams.all %}
                        <div class="row g-3 justify-content-center">
                            {% for team in court.all_teams.all %}
                                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                                    <div class="card team-card h-100 border-0 shadow-sm text-center p-2">
                                        {% if team.team_image %}
                                            <img src="{{ team.team_image.url }}" alt="{{ team.name }}" class="rounded-circle mb-2" width="80" height="80">
                                        {% else %}
                                            <img src="https://pickleit.app/static/images/pickleit_newlogo.jpg" alt="{{ team.name }}" class="rounded-circle mb-2" width="80" height="80">
                                        {% endif %}
                                        <h6 class="card-title mb-0">{{ team.name }}</h6>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No teams have joined yet.</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

    </div>
</div>

{% endif %}




<!-- Matches -->
<div class="card text-center">
    <div class="card-header text-center d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <h2 class="h5">Matches</h2>
    </div>
    <div class="card-body">
        <div class="row">
            {% for match in matches %}
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="versus-card">
                    <h3><span><i class="" data-feather="compass"></i></span>{{ match.leagues.name }}</h3>
                    <div class="v-team">
                        <div class="v-team-left">
                            <p><img src="https://pickleit.app/static/images/pickleit_newlogo.jpg" alt="" class="me-2">{{ match.team1.name }}</p>
                            <p><img src="https://pickleit.app/static/images/pickleit_newlogo.jpg" alt="" class="me-2">{{ match.team2.name }}</p>
                        </div>
                        <div class="v-team-right">
                            <p>{{ match.created_at.date}} <span>{{ match.created_at.time}}</span></p>
                        </div>
                    </div>
                    <div class="v-info">
                        <p><strong>Match</strong> {{ match.match_number }}</p>
                        <a class="btn btn-info" data-bs-toggle="collapse" href="#showdata{{ match.id }}" role="button" aria-expanded="false" aria-controls="showdata">View <i class="align-middle" data-feather="chevron-right"></i></a>
                    </div>
                    <div class="collapse mt-2" id="showdata{{ match.id }}">
                        <div class="card card-body">
                            <table class="table">
                                <thead>
                                  <tr>
                                    <th>Sr. No.</th>
                                    <th>{{match.team1.name}}</th>
                                    <th>{{match.team2.name}}</th>
                                    <th>Status</th>
                                  </tr>
                                </thead>
                                <tbody>
                                    {% for score in match.score %}
                                    <tr>
                                        <td>{{ score.set_number }}</td>
                                        <td>{{ score.team1_point}}</td>
                                        <td>{{ score.team2_point}}</td>
                                        <td><a href="javascript:void(0);" class="btn btn-success">{{score.win_team.name}}</a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                              </table>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
                <p class="text-danger text-center">No matches available</p>
            {% endfor %}
        </div>
    </div>
    
</div>




<div class="container mt-5">
    <h1 class="mb-4 text-center">League Point Tables</h1>
    <ul class="nav nav-tabs" id="courtTabs" role="tablist">
        {% for court_data in point_table %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if forloop.first %}active{% endif %}" 
                        id="court-{{ court_data.id }}-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#court-{{ court_data.id }}" 
                        type="button" 
                        role="tab" 
                        aria-controls="court-{{ court_data.id }}" 
                        aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                    Court {{ court_data.court }}
                </button>
            </li>
        {% endfor %}
    </ul>
    <div class="tab-content" id="courtTabContent">
        {% for court_data in point_table %}
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                    id="court-{{ court_data.id }}" 
                    role="tabpanel" 
                    aria-labelledby="court-{{ court_data.id }}-tab">
                <div class="card text-center mt-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <table class="table table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Team</th>
                                            <th>Matches Played</th>
                                            <th>Wins</th>
                                            <th>Losses</th>
                                            <th>Draws</th>
                                            <th>Points</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for team in court_data.all_teams|dictsortreversed:"point" %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ team.name }}</td>
                                                <td>{{ team.completed_match }}</td>
                                                <td>{{ team.win_match }}</td>
                                                <td>{{ team.loss_match }}</td>
                                                <td>{{ team.drow_match }}</td>
                                                <td><strong>{{ team.point }}</strong></td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="7" class="text-center text-danger">No matches played yet.</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.getElementById("teamSearch").addEventListener("input", function () {
        let searchValue = this.value.toLowerCase();
        let teams = document.querySelectorAll(".team-card");

        teams.forEach(function (team) {
            let teamName = team.querySelector("h6").innerText.toLowerCase();
            if (teamName.includes(searchValue)) {
                team.style.display = "flex";
            } else {
                team.style.display = "none";
            }
        });
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Start Tournament Modal Logic
        const maxTeams = {{ event.max_number_team }};
        const registeredTeams = {{ event.registered_team.count }};

        document.getElementById("maxTeams").innerText = maxTeams;
        document.getElementById("registeredTeams").innerText = registeredTeams;

        const warningMessage = document.getElementById("warningMessage");
        if (registeredTeams < maxTeams) {
            warningMessage.innerText = "Warning: Not all slots are filled.";
        } else {
            warningMessage.innerText = "";
        }
    });
</script>
{% endblock %}
